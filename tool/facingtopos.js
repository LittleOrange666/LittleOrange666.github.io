"use strict";var _createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(e,t,r){if(t)n(e.prototype,t);if(r)n(e,r);return e}}();function _defineProperty(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function _possibleConstructorReturn(e,t){if(!e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t&&(typeof t==="object"||typeof t==="function")?t:e}function _inherits(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof t)}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:false,writable:true,configurable:true}});if(t)Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t}function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var document_getElementById=function e(t){return document.getElementById(t)};var uparea=document_getElementById("uparea");var triple_standard_point=document_getElementById("triple_standard_point");var tp_attributes=document_getElementById("tp_attributes");var third_standard_point_div=document_getElementById("third_standard_point_div");var third_standard_point=document_getElementById("third_standard_point");var standardable_attributes=document_getElementById("standardable_attributes");var standard_y=document_getElementById("standard_y");var standard_x=document_getElementById("standard_x");var standard_point_color_div=document_getElementById("standard_point_color_div");var standard_point=document_getElementById("standard_point");var settings_tab=document_getElementById("settings_tab");var settings=document_getElementById("settings");var seg_attributes=document_getElementById("seg_attributes");var second_standard_point=document_getElementById("second_standard_point");var rightarea=document_getElementById("rightarea");var profiles_tab=document_getElementById("profiles_tab");var profiles=document_getElementById("profiles");var profile_uploader=document_getElementById("profile_uploader");var profile_upload=document_getElementById("profile_upload");var profile_download=document_getElementById("profile_download");var pos_attributes=document_getElementById("pos_attributes");var poly_attributes=document_getElementById("poly_attributes");var pointnamer=document_getElementById("pointnamer");var pointcolorr=document_getElementById("pointcolorr");var objlister=document_getElementById("objlister");var objlist_tab=document_getElementById("objlist_tab");var objlist=document_getElementById("objlist");var main_attributes=document_getElementById("main_attributes");var leftarea=document_getElementById("leftarea");var label_point2=document_getElementById("label_point2");var label_point1=document_getElementById("label_point1");var label_objtype=document_getElementById("label_objtype");var input_color=document_getElementById("input_color");var img_copy=document_getElementById("img_copy");var gaslinker=document_getElementById("gaslinker");var first_standard_point=document_getElementById("first_standard_point");var facinglabel=document_getElementById("facinglabel");var facingin3=document_getElementById("facingin3");var facingin2=document_getElementById("facingin2");var facingin1=document_getElementById("facingin1");var facingin=document_getElementById("facingin");var distancein=document_getElementById("distancein");var curve_attributes=document_getElementById("curve_attributes");var canvas=document_getElementById("canvas");var btn_select=document_getElementById("btn_select");var btn_segment=document_getElementById("btn_segment");var btn_polygon=document_getElementById("btn_polygon");var btn_point=document_getElementById("btn_point");var btn_move=document_getElementById("btn_move");var btn_ftp=document_getElementById("btn_ftp");var btn_findgood=document_getElementById("btn_findgood");var btn_download=document_getElementById("btn_download");var btn_destroy=document_getElementById("btn_destroy");var btn_curve=document_getElementById("btn_curve");var btn_copy=document_getElementById("btn_copy");var btn_color=document_getElementById("btn_color");var attributes_tab=document_getElementById("attributes_tab");var attributes=document_getElementById("attributes");var attribute_y=document_getElementById("attribute_y");var attribute_x=document_getElementById("attribute_x");var attribute_update=document_getElementById("attribute_update");var attribute_standardable=document_getElementById("attribute_standardable");var attribute_power=document_getElementById("attribute_power");var attribute_named2=document_getElementById("attribute_named2");var attribute_named1=document_getElementById("attribute_named1");var attribute_name=document_getElementById("attribute_name");var attribute_length=document_getElementById("attribute_length");var attribute_facing2=document_getElementById("attribute_facing2");var attribute_facing1=document_getElementById("attribute_facing1");var attribute_delete=document_getElementById("attribute_delete");var attribute_color=document_getElementById("attribute_color");var attribute_area=document_getElementById("attribute_area");var smallerscale=0;var fl=Math.round;function make(e,t){var r=document.createElement(e);r.innerText=t;return r}var Pos=function(){function n(e,t){_classCallCheck(this,n);this.x=e;this.y=t}_createClass(n,[{key:"add",value:function e(t,r){if(r===undefined){return new n(this.x+t.x,this.y+t.y)}return new n(this.x+t,this.y+r)}},{key:"sub",value:function e(t,r){if(r===undefined){return new n(this.x-t.x,this.y-t.y)}return new n(this.x-t,this.y-r)}},{key:"mul",value:function e(t){return new n(this.x*t,this.y*t)}},{key:"equal",value:function e(t){return this.x==t.x&&this.y==t.y}},{key:"toPolar",value:function e(){return new PolarPos(Math.sqrt(this.x*this.x+this.y*this.y),Math.atan2(this.y,this.x)/PolarPos.mul)}},{key:"copy",value:function e(){return new n(this.x,this.y)}},{key:"ud",value:function e(){return new n(this.x,-this.y)}},{key:"toString",value:function e(){return"("+this.x+", "+this.y+")"}},{key:"length",get:function e(){return Math.sqrt(this.x*this.x+this.y*this.y)},set:function e(t){var r=t/this.length;this.x*=r;this.y*=r}}]);return n}();var PolarPos=function(e){_inherits(n,e);function n(e,t){_classCallCheck(this,n);var r=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e*Math.cos(t*n.mul),e*Math.sin(t*n.mul)));r.r=e;r.theta=t;return r}_createClass(n,[{key:"setXY",value:function e(t,r){this.r=Math.sqrt(t*t+r*r);this.theta=Math.atan2(r,t)/n.mul}},{key:"x",get:function e(){return this.r*Math.cos(this.theta*n.mul)},set:function e(t){this.setXY(t,this.y)}},{key:"y",get:function e(){return this.r*Math.sin(this.theta*n.mul)},set:function e(t){this.setXY(this.x,t)}},{key:"length",get:function e(){return this.r},set:function e(t){this.r=t}}]);return n}(Pos);PolarPos.mul=Math.PI/180;function _uuid(){var r=Date.now();if(typeof performance!=="undefined"&&typeof performance.now==="function"){r+=performance.now()}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(r+Math.random()*16)%16|0;r=Math.floor(r/16);return(e==="x"?t:t&3|8).toString(16)})}var Parts=function(){function e(){_classCallCheck(this,e);this.arr=[]}_createClass(e,[{key:"add",value:function e(t){this.arr.push(t);updatelister()}},{key:"remove",value:function e(t){this.arr.splice(this.arr.indexOf(t),1);updatelister()}},{key:"get",value:function e(t){var r=true;var n=false;var a=undefined;try{for(var i=this.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;if(s.uuid==t){return s}}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}return null}},{key:"find",value:function e(t){var r=true;var n=false;var a=undefined;try{for(var i=this.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;if(s.contains(t)){return s}}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}return null}},{key:"findpoint",value:function e(t){var r=true;var n=false;var a=undefined;try{for(var i=this.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;if(s.ispoint()&&s.contains(t)){return s}}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}return null}},{key:"findnontag",value:function e(t){var r=true;var n=false;var a=undefined;try{for(var i=this.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;if(!s.istag()&&s.contains(t)){return s}}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}return null}},{key:"draws",value:function e(){for(var t=this.arr.length-1;t>=0;t--){this.arr[t].draw()}}},{key:"updatepos",value:function e(){var t=true;var r=false;var n=undefined;try{for(var a=this.arr[Symbol.iterator](),i;!(t=(i=a.next()).done);t=true){var o=i.value;o.updatepos()}}catch(e){r=true;n=e}finally{try{if(!t&&a.return){a.return()}}finally{if(r){throw n}}}updatelister()}},{key:"forEach",value:function e(t){var r=true;var n=false;var a=undefined;try{for(var i=this.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;t(s)}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}}}]);return e}();var parts=new Parts;function textSize(e,t){var r=document.createElement("span");var n=new Pos(0,0);n.width=r.offsetWidth;n.height=r.offsetHeight;r.style.visibility="hidden";r.style.fontSize=e;r.style.display="inline-block";document.body.appendChild(r);if(typeof r.textContent!="undefined"){r.textContent=t}else{r.innerText=t}n.x=parseFloat(window.getComputedStyle(r).width)-n.width;n.y=parseFloat(window.getComputedStyle(r).height)-n.height;document.body.removeChild(r);return n}var Part=function(){function r(e,t){_classCallCheck(this,r);this._center=e;this.size=t;this.children=[];this.important=false;this.tag=null;parts.add(this);this.destroyed=false;this._name="";if(!this.istag()){this.tag=new Tag(this,this.name,15);this.tag.moveto(this.canvaspos.add(new Pos(0,-10)))}this.parttype="Part";this.display=true;this.uuid=_uuid()}_createClass(r,[{key:"contains",value:function e(t){var r=t.sub(this.canvaspos);return Math.abs(r.x)<this.size.x/2&&Math.abs(r.y)<this.size.y/2}},{key:"moveto",value:function e(t){this.canvaspos=t;this.children.forEach(function(e){return e.updatepos()});if(this.standardable||this.important)parts.updatepos()}},{key:"addchild",value:function e(t){this.children.push(t)}},{key:"updatepos",value:function e(){}},{key:"draw",value:function e(){}},{key:"selected",value:function e(){}},{key:"ispoint",value:function e(){return false}},{key:"candestroy",value:function e(){return false}},{key:"destroy",value:function e(){this.destroyed=true;parts.remove(this)}},{key:"lowercolor",value:function e(t){var r=Math.floor((parseInt(t.substr(1,2),16)+510)/3);var n=Math.floor((parseInt(t.substr(3,2),16)+510)/3);var a=Math.floor((parseInt(t.substr(5,2),16)+510)/3);return"#"+r.toString(16)+n.toString(16)+a.toString(16)}},{key:"istag",value:function e(){return false}},{key:"name",set:function e(t){this._name=t;if(!this.istag()){this.tag.text=t;if(!this.usingnamer)updatelister();else updatename()}},get:function e(){return this._name}},{key:"center",set:function e(t){var r=this.canvaspos;this._center=t;var n=true;var a=false;var i=undefined;try{for(var o=this.children[Symbol.iterator](),s;!(n=(s=o.next()).done);n=true){var l=s.value;if(!l.destroyed){l.moveto(l.canvaspos.add(this.canvaspos).sub(r));l.updatepos()}}}catch(e){a=true;i=e}finally{try{if(!n&&o.return){o.return()}}finally{if(a){throw i}}}if(this.tag){this.tag.moveto(this.tag.canvaspos.add(this.canvaspos).sub(r));this.tag.updatepos()}},get:function e(){return this._center}},{key:"canvaspos",get:function e(){return this._center.ud().add(new Pos(1,1)).mul(size/2)},set:function e(t){this.center=t.mul(2/size).sub(new Pos(1,1)).ud()}},{key:"realpos",get:function e(){var t=this.center.sub(reference_center()).toPolar();t.r=t.r*reallength();t.theta=t.theta-north()+90;return reference_pos().add(t)}},{key:"readpos",set:function e(t){}}]);return r}();var Segment=function(e){_inherits(a,e);function a(e,t,r){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e.center.add(t.center).mul(.5),new Pos(1,1)));if(r==undefined){r="#000000"}n.color=r;n.point1=e;n.point2=t;n.parttype="Segment";return n}_createClass(a,[{key:"draw",value:function e(){if(this.point1.destroyed||this.point2.destroyed){this.destroy()}if(this.color!=undefined){ctx.strokeStyle=this.color}ctx.lineWidth=2;drawline(this.point1.canvaspos.x,this.point1.canvaspos.y,this.point2.canvaspos.x,this.point2.canvaspos.y)}},{key:"selected",value:function e(){if(this.point1.destroyed||this.point2.destroyed){this.destroy()}if(this.color!=undefined){ctx.strokeStyle=this.lowercolor(this.color)}ctx.lineWidth=6;drawline(this.point1.canvaspos.x,this.point1.canvaspos.y,this.point2.canvaspos.x,this.point2.canvaspos.y)}},{key:"moveto",value:function e(t){}},{key:"contains",value:function e(t){var r=3;var n=this.point1.canvaspos;var a=this.point2.canvaspos;var i=Math.min(n.x,a.x)-r;var o=Math.max(n.x,a.x)+r;var s=Math.min(n.y,a.y)-r;var l=Math.max(n.y,a.y)+r;if(t.x>=i&&t.x<=o&&t.y>=s&&t.y<=l){var c=n.y-a.y;var u=a.x-n.x;var d=n.y*a.x-a.y*n.x;var p=Math.abs(c*t.x+u*t.y-d)/Math.sqrt(c*c+u*u);return p<=r}return false}},{key:"ispoint",value:function e(){return false}},{key:"candestroy",value:function e(){return true}},{key:"length",get:function e(){var t=this.point1.center.sub(this.point2.center);return Math.sqrt(t.x*t.x+t.y*t.y)},set:function e(t){}}]);return a}(Part);var Curve=function(e){_inherits(a,e);function a(e,t){_classCallCheck(this,a);var r=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,new Pos(0,0),new Pos(0,0)));if(t==undefined){t="#0000FF"}r.color=t;r.parts=e;r.length=e.length;r.parttype="Curve";r.power=0;r.ok=false;r.data=null;for(var n=0;n<r.length;n++){r.parts[n].addchild(r)}return r}_createClass(a,[{key:"candestroy",value:function e(){return true}},{key:"draw",value:function e(){if(this.color!=undefined){ctx.strokeStyle=this.color}if(!this.ok){this.ok=true;this.data=createcurve(this.parts,this.power)}ctx.lineWidth=2;justdrawcurve(this.data)}},{key:"updatepos",value:function e(){this.ok=false}}]);return a}(Part);var Polygon=function(e){_inherits(a,e);function a(e,t){_classCallCheck(this,a);var r=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,new Pos(0,0),new Pos(0,0)));if(t==undefined){t="#0000FF"}r.color=t;r.parts=e;r.length=e.length;r.parts[r.length]=r.parts[0];r.segs=[];for(var n=0;n<r.length;n++){r.segs[n]=new Segment(r.parts[n],r.parts[n+1],t);r.segs[n].inpolygon=true;r.parts[n].addchild(r)}r.parttype="Polygon";return r}_createClass(a,[{key:"getarea",value:function e(){var t=0;for(var r=0;r<this.length;r++){t+=this.parts[r].center.x*this.parts[r+1].center.y;t-=this.parts[r].center.y*this.parts[r+1].center.x}return Math.abs(t)/2}},{key:"destroy",value:function e(){this.destroyed=true;parts.remove(this);var t=true;var r=false;var n=undefined;try{for(var a=this.segs[Symbol.iterator](),i;!(t=(i=a.next()).done);t=true){var o=i.value;if(!o.destroyed)o.destroy()}}catch(e){r=true;n=e}finally{try{if(!t&&a.return){a.return()}}finally{if(r){throw n}}}}},{key:"candestroy",value:function e(){return true}},{key:"draw",value:function e(){if(this.color!=undefined){ctx.strokeStyle=this.color}var t=this.color;var r=fl(255-(255-parseInt(t.substr(1,2),16))/3);var n=fl(255-(255-parseInt(t.substr(3,2),16))/3);var a=fl(255-(255-parseInt(t.substr(5,2),16))/3);ctx.fillStyle="#"+r.toString(16)+n.toString(16)+a.toString(16);ctx.beginPath();ctx.moveTo(fl(this.parts[0].canvaspos.x),fl(this.parts[0].canvaspos.y));for(var i=1;i<this.parts.length;i++){ctx.lineTo(fl(this.parts[i].canvaspos.x),fl(this.parts[i].canvaspos.y))}ctx.fill()}}]);return a}(Part);var Point=function(e){_inherits(a,e);function a(e,t,r){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e,new Pos(t*2,t*2)));n.radius=t;n.color=r;n.parttype="Point";return n}_createClass(a,[{key:"draw",value:function e(){ctx.strokeStyle="#000000";if(this.color!=undefined){ctx.fillStyle=this.color}ctx.lineWidth=.5;drawcircle(this.canvaspos.x,this.canvaspos.y,this.radius)}},{key:"selected",value:function e(){if(this.color!=undefined){ctx.fillStyle=this.lowercolor(this.color)}ctx.lineWidth=.1;drawcircle(this.canvaspos.x,this.canvaspos.y,this.radius*2)}},{key:"ispoint",value:function e(){return true}},{key:"candestroy",value:function e(){return this.is_new_point===true&&!this.standardable}}]);return a}(Part);var FixedPoint=function(e){_inherits(i,e);function i(e,t,r,n){_classCallCheck(this,i);var a=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t,r));a.getpos=n;a.parttype="FixedPoint";return a}_createClass(i,[{key:"moveto",value:function e(t){}},{key:"updatepos",value:function e(){if(this.getpos!=undefined){this.center=this.getpos(this)}}}]);return i}(Point);var NorthPoint=function(e){_inherits(a,e);function a(e,t,r,n){_classCallCheck(this,a);return _possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e,t,r,n))}_createClass(a,[{key:"moveto",value:function e(t){if(drag.northing){var r=t.sub(midpoint.canvaspos).toPolar().theta-this.canvaspos.sub(midpoint.canvaspos).toPolar().theta;var n=parts.arr;for(var a in n){if(n[a].parttype=="Point"&&!n[a].isnorth){var i=n[a].canvaspos.sub(midpoint.canvaspos).toPolar();i.theta+=r;n[a].moveto(midpoint.canvaspos.add(i))}}}}}]);return a}(FixedPoint);var Tag=function(e){_inherits(a,e);function a(e,t,r){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e.center.copy(),textSize(r,t)));n.parent=e;n._text=t;n.tsize=r;e.tag=n;n.parttype="Tag";n.display=false;return n}_createClass(a,[{key:"moveto",value:function e(t){var r=t.sub(this.parent.canvaspos);var n=r.x*r.x+r.y*r.y;var a=this.tsize*this.tsize*10;if(n>a){r=r.mul(Math.sqrt(a/n));this.canvaspos=this.parent.canvaspos.add(r)}else{this.canvaspos=t}}},{key:"updatepos",value:function e(){if(isNaN(this.center.x)||isNaN(this.center.y)){this.center=this.parent.center.copy();return}var t=this.parent.canvaspos.sub(this.canvaspos);var r=t.x*t.x+t.y*t.y;var n=this.tsize*this.tsize*10;if(r>n){t=t.mul(Math.sqrt(n/r));this.canvaspos=this.parent.canvaspos.sub(t)}}},{key:"draw",value:function e(){if(this.parent.destroyed){this.destroy()}ctx.font=this.tsize+"px 標楷體";ctx.fillStyle="#000000";ctx.strokeStyle="#000000";ctx.fillText(this.text,this.canvaspos.x,this.canvaspos.y)}},{key:"istag",value:function e(){return true}},{key:"text",set:function e(t){this._text=t;this.size=textSize(this.tsize,t)},get:function e(){return this._text}}]);return a}(Part);function intersect(e,t,r,n,a,i){var o=e*a-n*t;var s=r*a-i*t;var l=e*i-n*r;return new Pos(s/o,l/o)}function posfinder(e,t,r,n){var a=north();var i=e;var o=i.add(new PolarPos(1,a-r));var s=i.y-o.y;var l=o.x-i.x;var c=i.y*o.x-o.y*i.x;var u=t;var d=u.add(new PolarPos(1,a-n));var p=u.y-d.y;var f=d.x-u.x;var v=u.y*d.x-d.y*u.x;return intersect(s,l,c,p,f,v)}var ThePoint=function(e){_inherits(s,e);function s(e,t,r,n,a,i){_classCallCheck(this,s);var o=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,new Pos(0,0),5,i,function(e){return posfinder(e.part1.center,e.part2.center,e.angle1,e.angle2)}));o.part1=n;o.part2=a;o.name=r;o.angle1=e;o.angle2=t;o.updatepos();o.parttype="ThePoint";return o}_createClass(s,[{key:"candestroy",value:function e(){return!this.standardable}}]);return s}(FixedPoint);var canvaspos=new Pos(0,0);var size=0;var ctx;var canvaschecker={size1:0,size2:0};function checkcanvaspos(){if(document.body.clientWidth!=canvaschecker.size1){updatecanvaspos()}else if(window.screen.height-160-uparea.clientHeight-smallerscale!=canvaschecker.size2){updatecanvaspos()}}function updatecanvaspos(){var e=document.body.clientWidth;var t=window.screen.height-160-uparea.clientHeight-smallerscale;size=Math.min(e,t);canvas.width=size;canvas.height=size;if(e<t){canvaspos.x=0;canvaspos.y=fl((t-size)/2)+uparea.clientHeight}else{canvaspos.x=fl((e-size)/2);canvaspos.y=uparea.clientHeight}ctx=canvas.getContext("2d");ctx.textAlign="center";canvaschecker.size1=e;canvaschecker.size2=t}updatecanvaspos();window.setInterval(refresh,30);var mouse=new Pos(0,0);mouse.incanvas=function(){return this.x>0&&this.y>0&&this.x<size&&this.y<size};window.addEventListener("mousemove",function(e){clicker.curveok=false;mouse.x=e.pageX-canvaspos.x-0+(rightarea.clientWidth-leftarea.clientWidth)/2;mouse.y=e.pageY-canvaspos.y-2;if(drag.isdraging){draging()}});function drawline(e,t,r,n){ctx.beginPath();ctx.moveTo(fl(e),fl(t));ctx.lineTo(fl(r),fl(n));ctx.stroke()}function drawcircle(e,t,r){ctx.beginPath();ctx.arc(fl(e),fl(t),fl(r),0,Math.PI*2);ctx.fill();ctx.stroke()}function drawcurve(e,t){justdrawcurve(createcurve(e,t))}function createcurve(e,t){if(t===undefined)t=0;var r=e.length;var n=[];for(var a=0;a<r;a++){if(e[a].canvaspos){n[a]=e[a].canvaspos}else{n[a]=e[a]}}var i=[];var o=0;i[0]=0;var s=0;for(var l=1;l<r;l++){o+=Math.pow(n[l].sub(n[l-1]).length,t);s+=n[l].sub(n[l-1]).length;i[l]=o}var c=i[r-1];s=Math.ceil(s/2);for(var u=1;u<r;u++){i[u]/=c}var d=[];var p=[];for(var f=0;f<r;f++){d[f]=[];p[f]=[];for(var v=0;v<r;v++){d[f][v]=Math.pow(i[f],v);p[f][v]=Math.pow(i[f],v)}d[f][r]=n[f].x;p[f][r]=n[f].y}for(var h=0;h<r;h++){for(var _=0;_<r;_++){if(_!=h){var y=d[_][h]/d[h][h];var m=p[_][h]/p[h][h];for(var g=0;g<=r;g++){d[_][g]-=y*d[h][g];p[_][g]-=m*p[h][g]}}}}var b=[];var k=[];for(var x=0;x<r;x++){b[x]=d[x][r]/d[x][x];k[x]=p[x][r]/p[x][x]}var w=[];var E=false;for(var P=0;P<=s;P++){var I=0;var C=0;var B=P/s;var S=1;for(var L=0;L<r;L++){I+=b[L]*S;C+=k[L]*S;S*=B}w.push(new Pos(I,C));if(I>0&&C>0&&I<size&&C<size){E=true}}if(!E){w=[w[0]]}return w}function justdrawcurve(e){ctx.beginPath();ctx.moveTo(e[0].x,e[0].y);for(var t=1;t<e.length;t++){ctx.lineTo(e[t].x,e[t].y)}ctx.stroke()}var drag={isdraging:false,part:null,previous:new Pos(0,0),lc:new Pos(0,0),northing:false};function startdrag(){drag.previous=mouse.copy();drag.part=parts.find(mouse);drag.isdraging=true;if(drag.part){drag.lc=drag.part.canvaspos}}function draging(){if(mouse.incanvas()){if(drag.part){drag.lc=drag.lc.add(mouse).sub(drag.previous);if(drag.part.uuid==northpoint.uuid)drag.northing=true;drag.part.moveto(drag.lc);drag.northing=false}else{var e=parts.arr;for(var t in e){if(e[t].parttype=="Point"&&!e[t].isnorth){e[t].moveto(e[t].canvaspos.add(mouse).sub(drag.previous))}}}drag.previous=mouse.copy();refresh_attributes()}else{enddrag()}}function enddrag(){drag.isdraging=false}canvas.onmousedown=function(e){return startdrag()};canvas.onmouseup=function(e){return enddrag()};function zoom(e){e.preventDefault();var t=Math.pow(2,e.deltaY*-.001);var r=parts.arr;for(var n in r){if(r[n].parttype=="Point"&&!r[n].isnorth){r[n].moveto(r[n].canvaspos.sub(mouse).mul(t).add(mouse))}}}canvas.onwheel=zoom;var clicker={isseging:false,ismoving:false,curvedata:null,curveok:false,polypoints:[],polysegs:[],selected:null,method:"select",refreshbtn:function e(){clicker.isseging=false;clicker.ismoving=false;btn_select.innerHTML="選取";btn_move.innerHTML="移動";btn_point.innerHTML="新點";btn_segment.innerHTML="線段";btn_polygon.innerHTML="多邊形";btn_curve.innerHTML="曲線";btn_color.innerHTML="改顏色";clicker.polypoints=[];var t=true;var r=false;var n=undefined;try{for(var a=clicker.polysegs[Symbol.iterator](),i;!(t=(i=a.next()).done);t=true){var o=i.value;o.destroy()}}catch(e){r=true;n=e}finally{try{if(!t&&a.return){a.return()}}finally{if(r){throw n}}}clicker.polysegs=[]},lp:function e(){return clicker.polypoints[clicker.polypoints.length-1]}};btn_select.addEventListener("click",function(){if(clicker.method=="select")return;clicker.refreshbtn();clicker.method="select";btn_select.innerHTML+="√"});btn_move.addEventListener("click",function(){if(clicker.method=="move")return;clicker.refreshbtn();clicker.method="move";btn_move.innerHTML+="√";if(clicker.selected&&!clicker.ismoving){clicker.ismoving=true}});btn_point.addEventListener("click",function(){if(clicker.method=="point")return;clicker.refreshbtn();clicker.method="point";btn_point.innerHTML+="√";clicker.selected=null});btn_segment.addEventListener("click",function(){if(clicker.method=="segment")return;clicker.refreshbtn();clicker.method="segment";btn_segment.innerHTML+="√";if(clicker.selected&&!clicker.isseging){clicker.isseging=true}});btn_polygon.addEventListener("click",function(){if(clicker.method=="polygon")return;clicker.refreshbtn();clicker.method="polygon";btn_polygon.innerHTML+="√"});btn_curve.addEventListener("click",function(){if(clicker.method=="curve")return;clicker.refreshbtn();clicker.method="curve";btn_curve.innerHTML+="√"});btn_color.addEventListener("click",function(){if(clicker.method=="color")return;clicker.refreshbtn();clicker.method="color";btn_color.innerHTML+="√";if(clicker.selected){clicker.selected.color=input_color.value}});input_color.addEventListener("change",function(){if(clicker.selected&&clicker.method=="color"){clicker.selected.color=input_color.value}});btn_destroy.addEventListener("click",function(){if(clicker.selected){if(clicker.selected.candestroy())clicker.selected.destroy();clicker.selected=null}});function onmouseclick(){if(clicker.method=="point"){var e=new Point(new Pos(0,0),10,input_color.value);e.moveto(mouse);e.is_new_point=true;clicker.refreshbtn();clicker.method="select";btn_select.innerHTML+="√";updatelister()}if(clicker.method=="segment"){if(!clicker.isseging){clicker.selected=parts.findpoint(mouse);if(clicker.selected!=null){clicker.isseging=true}refresh_attributes()}else{clicker.isseging=false;var t=parts.findpoint(mouse);if(t!=null){new Segment(clicker.selected,t,input_color.value);updatelister()}clicker.selected=null;refresh_attributes()}}if(clicker.method=="polygon"){if(clicker.polypoints.length==0){clicker.selected=parts.findpoint(mouse);if(clicker.selected!=null){clicker.polypoints[0]=clicker.selected}refresh_attributes()}else{var r=parts.findpoint(mouse);if(r!=null){if(r==clicker.polypoints[0]){new Polygon(clicker.polypoints,input_color.value);clicker.polypoints=[];var n=true;var a=false;var i=undefined;try{for(var o=clicker.polysegs[Symbol.iterator](),s;!(n=(s=o.next()).done);n=true){var l=s.value;l.destroy()}}catch(e){a=true;i=e}finally{try{if(!n&&o.return){o.return()}}finally{if(a){throw i}}}clicker.polysegs=[]}else{clicker.polysegs.push(new Segment(clicker.lp(),r,input_color.value));clicker.polypoints.push(r)}updatelister()}}}if(clicker.method=="curve"){if(clicker.polypoints.length==0){clicker.selected=parts.findpoint(mouse);if(clicker.selected!=null){clicker.polypoints[0]=clicker.selected}refresh_attributes()}else{var c=parts.findpoint(mouse);if(c!=null){clicker.polypoints.push(c)}else{if(clicker.polypoints.length>1)new Curve(clicker.polypoints,input_color.value);clicker.polypoints=[];updatelister()}}}if(clicker.method=="move"){if(!clicker.ismoving){clicker.selected=parts.findpoint(mouse);if(clicker.selected!=null){clicker.ismoving=true}refresh_attributes()}else{clicker.ismoving=false;clicker.selected.moveto(mouse);clicker.selected=null;refresh_attributes()}}if(clicker.method=="color"){clicker.selected=parts.findnontag(mouse);if(clicker.selected!=null){clicker.selected.color=input_color.value}refresh_attributes()}if(clicker.method=="select"){clicker.selected=parts.findnontag(mouse);refresh_attributes()}}canvas.onclick=function(e){return onmouseclick()};function onseging(){ctx.strokeStyle=input_color.value;ctx.lineWidth=2;drawline(clicker.selected.canvaspos.x,clicker.selected.canvaspos.y,mouse.x,mouse.y)}function onpoly(){var e=input_color.value;var t=fl(255-(255-parseInt(e.substr(1,2),16))/3);var r=fl(255-(255-parseInt(e.substr(3,2),16))/3);var n=fl(255-(255-parseInt(e.substr(5,2),16))/3);ctx.fillStyle="#"+t.toString(16)+r.toString(16)+n.toString(16);ctx.strokeStyle=input_color.value;ctx.lineWidth=2;drawline(clicker.lp().canvaspos.x,clicker.lp().canvaspos.y,mouse.x,mouse.y);ctx.beginPath();ctx.moveTo(fl(clicker.polypoints[0].canvaspos.x),fl(clicker.polypoints[0].canvaspos.y));for(var a=1;a<clicker.polypoints.length;a++){ctx.lineTo(fl(clicker.polypoints[a].canvaspos.x),fl(clicker.polypoints[a].canvaspos.y))}ctx.lineTo(mouse.x,mouse.y);ctx.fill()}function oncurve(){if(!clicker.curveok){var e=clicker.polypoints.concat();e.push(mouse);clicker.curvedata=createcurve(e,0);clicker.curveok=true}ctx.strokeStyle=input_color.value;ctx.lineWidth=2;justdrawcurve(clicker.curvedata)}btn_download.addEventListener("click",function(){var e=document.createElement("a");e.href=canvas.toDataURL();e.download=(new Date).toISOString().replace(":","_")+".png";e.click()});btn_copy.addEventListener("click",function(){var e=document.createElement("canvas");var t=e.getContext("2d");var r=new Image;e.width=canvas.width;e.height=canvas.height;r.crossOrigin="Anonymous";r.src=canvas.toDataURL();img_copy.src=canvas.toDataURL();img_copy.onload=function(){var e=new Range;e.selectNode=img_copy;window.getSelection().removeAllRanges();window.getSelection().addRange(e);console.log(e)};r.onload=function(){t.clearRect(0,0,t.canvas.width,t.canvas.height);t.drawImage(r,0,0);e.toBlob(blob_copyer)}});function blob_copyer(e){console.log(e);var t=[new ClipboardItem(_defineProperty({},e.type,e))];navigator.clipboard.write(t).then(function(){console.log("Copied to clipboard successfully!")},function(){console.error("Unable to write to clipboard.")})}function getTimeStr(e){return e.getFullYear()+"/"+(e.getMonth()+1)+"/"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()}function saveTextAsFile(e,t){var r=new Blob([t],{type:"text/plain"});var n=document.createElement("a");n.download=e;n.innerHTML="Download File";if(window.webkitURL!=null){n.href=window.webkitURL.createObjectURL(r)}else{n.href=window.URL.createObjectURL(r);n.style.display="none";document.body.appendChild(n)}n.click()}function updatename(){facinglabel.innerHTML=part1.name+"相對於"+part2.name;label_point1.innerHTML=part1.name;label_point2.innerHTML=part2.name;var e=[];var t=parts.arr;for(var r in t){if(t[r].standardable){e.push(t[r].name)}}if(e.includes(first_standard_point.value)){e.splice(e.indexOf(first_standard_point.value),1);e.unshift(first_standard_point.value)}var n=first_standard_point.lastElementChild;while(n){first_standard_point.removeChild(n);n=first_standard_point.lastElementChild}for(var a in e){first_standard_point.appendChild(make("option",e[a]))}e.shift();if(e.includes(second_standard_point.value)){e.splice(e.indexOf(second_standard_point.value),1);e.unshift(second_standard_point.value)}n=second_standard_point.lastElementChild;while(n){second_standard_point.removeChild(n);n=second_standard_point.lastElementChild}for(var i in e){second_standard_point.appendChild(make("option",e[i]))}e.shift();if(e.includes(third_standard_point.value)){e.splice(e.indexOf(third_standard_point.value),1);e.unshift(third_standard_point.value)}n=third_standard_point.lastElementChild;while(n){third_standard_point.removeChild(n);n=third_standard_point.lastElementChild}for(var o in e){third_standard_point.appendChild(make("option",e[o]))}triple_standard_point.disabled=e.length==0;if(e.length==0)triple_standard_point.checked=false}function refresh_attributes(){if(clicker.selected){main_attributes.hidden=false;var e=clicker.selected.parttype;if(e=="ThePoint")e="所求點";if(e=="FixedPoint")e="固定點";if(e=="Point")e="動點";if(e=="Segment")e="線段";if(e=="Polygon")e="多邊形";if(e=="Curve")e="曲線";label_objtype.innerHTML="物件類型："+e;attribute_name.value=clicker.selected.name;attribute_color.value=clicker.selected.color;attribute_power.value=clicker.selected.power;var t=clicker.selected.realpos;attribute_x.value=Math.round(t.x*1e10)*1e-10;attribute_y.value=Math.round(t.y*1e10)*1e-10;attribute_x.oldvalue=attribute_x.value;attribute_y.oldvalue=attribute_y.value;attribute_x.disabled=true;attribute_y.disabled=true;tp_attributes.hidden=e!="所求點";if(e=="所求點"){attribute_named1.innerHTML="相對於"+clicker.selected.part1.name+"的方向角：";attribute_named2.innerHTML="相對於"+clicker.selected.part2.name+"的方向角："}seg_attributes.hidden=e!="線段";pos_attributes.hidden=e=="線段"||e=="多邊形";poly_attributes.hidden=e!="多邊形";attribute_facing1.value=clicker.selected.angle1;attribute_facing2.value=clicker.selected.angle2;if(e=="線段")attribute_length.value=clicker.selected.length*reallength();if(e=="多邊形")attribute_area.value=clicker.selected.getarea()*reallength()*reallength();attribute_delete.disabled=!clicker.selected.candestroy();standardable_attributes.hidden=!(e=="所求點"||e=="動點"&&clicker.selected.is_new_point);if(!standardable_attributes.hidden){attribute_standardable.checked=clicker.selected.standardable;attribute_standardable.disabled=false;if(clicker.selected.standardable){var r=true;var n=false;var a=undefined;try{for(var i=parts.arr[Symbol.iterator](),o;!(r=(o=i.next()).done);r=true){var s=o.value;if(s.parttype=="ThePoint"&&(s.part1.uuid==clicker.selected.uuid||s.part2.uuid==clicker.selected.uuid)){attribute_standardable.disabled=true;break}}}catch(e){n=true;a=e}finally{try{if(!r&&i.return){i.return()}}finally{if(n){throw a}}}}else{var l=true;var c=false;var u=undefined;try{for(var d=parts.arr[Symbol.iterator](),p;!(l=(p=d.next()).done);l=true){var f=p.value;if(f.standardable&&f.name==clicker.selected.name){attribute_standardable.disabled=true;break}}}catch(e){c=true;u=e}finally{try{if(!l&&d.return){d.return()}}finally{if(c){throw u}}}}}}else{main_attributes.hidden=true;label_objtype.innerHTML="尚未選取物件"}}attribute_name.addEventListener("input",function(){if(clicker.selected){clicker.selected.name=attribute_name.value;updatename()}});attribute_color.addEventListener("input",function(){if(clicker.selected){clicker.selected.color=attribute_color.value}});attribute_x.addEventListener("input",function(){if(clicker.selected){var e=clicker.selected.center;var t=Number(attribute_x.value);if(t>1||t<-1||isNaN(t)){t=e.x;attribute_x.value=e.x}clicker.selected.center=new Pos(t,e.y);clicker.selected.updatepos()}});attribute_y.addEventListener("input",function(){if(clicker.selected){var e=clicker.selected.center;var t=Number(attribute_y.value);if(t>1||t<-1||isNaN(t)){t=e.y;attribute_y.value=e.y}clicker.selected.center=new Pos(e.x,t);clicker.selected.updatepos()}});attribute_facing1.addEventListener("input",function(){if(clicker.selected){var e=Number(attribute_facing1.value);if(e>=0&&e<=360&&!isNaN(e))clicker.selected.angle1=e;clicker.selected.updatepos()}});attribute_facing2.addEventListener("input",function(){if(clicker.selected){var e=Number(attribute_facing2.value);if(e>=0&&e<=360&&!isNaN(e))clicker.selected.angle2=e;clicker.selected.updatepos()}});attribute_power.addEventListener("input",function(){if(clicker.selected){var e=Number(attribute_power.value);if(!isNaN(e))clicker.selected.power=e}});attribute_update.addEventListener("click",function(){if(clicker.selected){clicker.selected.updatepos();refresh_attributes()}});attribute_delete.addEventListener("click",function(){if(clicker.selected){clicker.selected.destroy();clicker.selected=null;refresh_attributes()}});attribute_standardable.addEventListener("change",function(){if(clicker.selected){clicker.selected.standardable=attribute_standardable.checked;updatename();refresh_attributes()}});function updatelister(){while(objlister.children.length>1){objlister.removeChild(objlister.children[1])}var e=true;var t=false;var r=undefined;try{var n=function e(){var t=u.value;if(t.display){var r=document.createElement("div");r.className="row";var n=document.createElement("div");n.className="col";var a=document.createElement("input");a.value=t.name;a.className="maxinput";t.namer=a;a.addEventListener("input",function(){t.usingnamer=true;t.name=a.value;t.usingnamer=false});n.appendChild(a);var i=document.createElement("div");i.className="col";var o=document.createElement("p");var s=t.parttype;if(s=="ThePoint")s="所求點";if(s=="FixedPoint")s="固定點";if(s=="Point")s="動點";if(s=="Segment")s="線段";if(s=="Polygon")s="多邊形";if(s=="Curve")s="曲線";o.innerHTML=s;i.appendChild(o);var l=document.createElement("div");l.className="col";var c=document.createElement("button");c.cpart=t;c.className="btn btn-primary btn-sm";c.innerHTML="選取";c.addEventListener("click",function(){clicker.selected=c.cpart;refresh_attributes();document.getElementById("attributes-tab").click()});l.appendChild(c);r.appendChild(n);r.appendChild(i);r.appendChild(l);objlister.appendChild(r)}};for(var a=parts.arr[Symbol.iterator](),u;!(e=(u=a.next()).done);e=true){n()}}catch(e){t=true;r=e}finally{try{if(!e&&a.return){a.return()}}finally{if(t){throw r}}}}function promptnumber(e){var t=NaN;var r=false;while(isNaN(t)){var n=prompt(e+(r?"(請輸入數字或按取消)":""),"0");if(n==null){return null}t=Number(n);r=true}return t}function averagecolor(e,t){var r=fl(parseInt(e.substr(1,2),16)+parseInt(t.substr(1,2),16));var n=fl(parseInt(e.substr(3,2),16)+parseInt(t.substr(3,2),16));var a=fl(parseInt(e.substr(5,2),16)+parseInt(t.substr(5,2),16));var i=1;if(r>255)i=i<r/255?i:r/255;if(n>255)i=i<n/255?i:n/255;if(a>255)i=i<a/255?i:a/255;r=Math.floor(r/i).toString(16);n=Math.floor(n/i).toString(16);a=Math.floor(a/i).toString(16);return"#"+(r.length>1?r:"0"+r)+(n.length>1?n:"0"+n)+(a.length>1?a:"0"+a)}function facingtopos(){var e=Number(facingin1.value);var t=Number(facingin2.value);var r=pointnamer.value;var n=parts.arr.find(function(e){return e.name==first_standard_point.value});var a=parts.arr.find(function(e){return e.name==second_standard_point.value});if(triple_standard_point.checked){var i=Number(facingin3.value);var o=parts.arr.find(function(e){return e.name==third_standard_point.value});new ThePoint(e,t,r,n,a,averagecolor(n.color,a.color));new ThePoint(e,i,r,n,o,averagecolor(n.color,o.color));new ThePoint(t,i,r,a,o,averagecolor(a.color,o.color))}else{new ThePoint(e,t,r,n,a,pointcolorr.value)}updatelister()}function checkfacingtopos(){var e=pointnamer.value;var t=e.length>0;var r=Number(facingin1.value);var n=Number(facingin2.value);var a=Number(facingin3.value);t=t&&!isNaN(r)&&!isNaN(n);t=t&&facingin1.value.length>0&&facingin2.value.length>0;t=t&&Math.abs(r-n)%180!=0;if(triple_standard_point.checked){t=t&&!isNaN(a)&&facingin3.value.length>0;t=t&&Math.abs(r-a)%180!=0&&Math.abs(n-a)%180!=0}btn_ftp.disabled=!t}facingin1.addEventListener("input",checkfacingtopos);facingin2.addEventListener("input",checkfacingtopos);pointnamer.addEventListener("input",checkfacingtopos);btn_ftp.addEventListener("click",facingtopos);function refresh(){checkcanvaspos();ctx.beginPath();ctx.rect(0,0,size,size);ctx.fillStyle="#FFFFFF";ctx.strokeStyle="#000000";ctx.fill();if(clicker.selected)clicker.selected.selected();parts.draws();if(clicker.isseging){onseging()}if(clicker.polypoints.length>0){if(clicker.method=="polygon"){onpoly()}else if(clicker.method=="curve"){oncurve()}}ctx.lineWidth=2;ctx.strokeStyle=midpoint.color;var e=midpoint.canvaspos;var t=northpoint.canvaspos;drawline(e.x,e.y,t.x,t.y);var r=e.sub(t).toPolar();r.theta+=30;r.r*=.2;var n=e.sub(t).toPolar();n.theta-=30;n.r*=.2;var a=t.add(r);var i=t.add(n);drawline(a.x,a.y,t.x,t.y);drawline(i.x,i.y,t.x,t.y)}var part1,part2,midpoint,northpoint;function init(){parts.arr=[];part1=new Point(new Pos(-.8,.8),10,"#00FFFF");part1.important=true;part1.name="基準點A";part1.standardable=true;part2=new Point(new Pos(-.8,-.8),10,"#FFFF00");part2.important=true;part2.name="基準點B";part2.standardable=true;midpoint=new Point(new Pos(.7,.7),4,"#000000");midpoint.name="方向標";northpoint=new NorthPoint(new Pos(0,0),3,"#666666",function(){return midpoint.center.add(new PolarPos(.2,north()))});midpoint.addchild(northpoint);northpoint.name="N";northpoint.updatepos();updatename();part1.isbase=true;part2.isbase=true;midpoint.isbase=true;northpoint.isbase=true;midpoint.isnorth=true;northpoint.isnorth=true}function createProfile(){var e={};var t=[];var r={};r.facing=facingin.value;r.distance=distancein.value;r.position_x=standard_x.value;r.position_y=standard_y.value;r.point=standard_point.value;r.point_1=first_standard_point.value;r.point_2=second_standard_point.value;r.point_3=third_standard_point.value;r.facing_1=facingin1.value;r.facing_2=facingin2.value;r.facing_3=facingin3.value;r.name=pointnamer.value;r.color=pointcolorr.value;r.name_1=part1.name;r.name_2=part2.name;r.name_3=midpoint.name;r.name_4=northpoint.name;r.color_1=part1.color;r.color_2=part2.color;r.color_3=midpoint.color;r.pos_1=part1.center;r.pos_2=part2.center;r.pos_3=midpoint.center;r.uuid1=part1.uuid;r.uuid2=part2.uuid;r.uuid3=midpoint.uuid;r.uuid4=northpoint.uuid;var n=parts.arr;var a=true;var i=false;var o=undefined;try{for(var s=n[Symbol.iterator](),l;!(a=(l=s.next()).done);a=true){var c=l.value;var u=null;if(!c.isbase){u={};u.pos=c.center;u.name=c.name;u.color=c.color;u.standardable=!!c.standardable;u.type=c.parttype;u.uuid=c.uuid;if(u.type=="ThePoint"){u.part1=c.part1.uuid;u.part2=c.part2.uuid;u.facing1=c.angle1;u.facing2=c.angle2;delete u.pos}else if(u.type=="Point"){}else if(u.type=="Segment"){u.point1=c.point1.uuid;u.point2=c.point2.uuid;if(c.inpolygon){u=null}}else if(u.type=="Polygon"){u.points=[];var d=c.parts;for(var p=0;p<d.length-1;p++){u.points[p]=d[p].uuid}}else if(u.type=="Curve"){u.points=[];var f=c.parts;for(var v=0;v<f.length;v++){u.points[v]=f[v].uuid}u.power=c.power}else{u=null}}if(u){t.push(u)}}}catch(e){i=true;o=e}finally{try{if(!a&&s.return){s.return()}}finally{if(i){throw o}}}e.settings=r;e.partlist=t;return JSON.stringify(e)}function readProfile(e){var t=JSON.parse(e);console.log(t);var r=t.settings;var n=t.partlist;var a={};init();part1.name=r.name_1;part2.name=r.name_2;midpoint.name=r.name_3;northpoint.name=r.name_4;updatename();a[r.uuid1]=part1;a[r.uuid2]=part2;a[r.uuid3]=midpoint;a[r.uuid4]=northpoint;facingin.value=r.facing;distancein.value=r.distance;standard_x.value=r.position_x;standard_y.value=r.position_y;standard_point.value=r.point;first_standard_point.value=r.point_1;second_standard_point.value=r.point_2;third_standard_point.value=r.point_3;facingin1.value=r.facing_1;facingin2.value=r.facing_2;facingin3.value=r.facing_3;pointnamer.value=r.name;pointcolorr.value=r.color;part1.color=r.color_1;part2.color=r.color_2;midpoint.color=r.color_3;part1.center=new Pos(r.pos_1.x,r.pos_1.y);part2.center=new Pos(r.pos_2.x,r.pos_2.y);midpoint.center=new Pos(r.pos_3.x,r.pos_3.y);var i=true;var o=false;var s=undefined;try{for(var l=n[Symbol.iterator](),c;!(i=(c=l.next()).done);i=true){var u=c.value;if(u.type=="ThePoint"){if(u.facing1===undefined){u.facing1=north()-a[u.part1].center.sub(new Pos(u.pos.x,u.pos.y)).toPolar().theta}if(u.facing2===undefined){u.facing2=north()-a[u.part2].center.sub(new Pos(u.pos.x,u.pos.y)).toPolar().theta}while(u.facing1>=360){u.facing1-=360}while(u.facing2>=360){u.facing2-=360}while(u.facing1<0){u.facing1+=360}while(u.facing2<0){u.facing2+=360}var d=new ThePoint(u.facing1,u.facing2,u.name,a[u.part1],a[u.part2],u.color);a[u.uuid]=d;d.standardable=u.standardable;if(d.standardable)d.radius=10}else if(u.type=="Point"){var p=new Point(new Pos(u.pos.x,u.pos.y),10,u.color);a[u.uuid]=p;p.standardable=u.standardable}else if(u.type=="Segment"){var f=new Segment(a[u.point1],a[u.point2],u.color)}else if(u.type=="Polygon"){var v=[];var h=true;var _=false;var y=undefined;try{for(var m=u.points[Symbol.iterator](),g;!(h=(g=m.next()).done);h=true){var b=g.value;v.push(a[b])}}catch(e){_=true;y=e}finally{try{if(!h&&m.return){m.return()}}finally{if(_){throw y}}}var k=new Polygon(v,u.color)}else if(u.type=="Curve"){var x=[];var w=true;var E=false;var P=undefined;try{for(var I=u.points[Symbol.iterator](),C;!(w=(C=I.next()).done);w=true){var B=C.value;x.push(a[B])}}catch(e){E=true;P=e}finally{try{if(!w&&I.return){I.return()}}finally{if(E){throw P}}}var S=new Curve(x,u.color)}}}catch(e){o=true;s=e}finally{try{if(!i&&l.return){l.return()}}finally{if(o){throw s}}}parts.updatepos();updatelister();updatename()}profile_download.addEventListener("click",function(){var e="方位找點"+getTimeStr(new Date)+".json";saveTextAsFile(e,createProfile())});var reader=new FileReader;profile_uploader.addEventListener("change",function(){var e=profile_uploader.files;profile_upload.disabled=!(e.length>0&&e[0].name.endsWith(".json"))});profile_upload.addEventListener("click",function(){reader.readAsText(profile_uploader.files[0])});reader.addEventListener("load",function(){readProfile(reader.result);profile_upload.disabled=true});function north(){return part1.center.sub(part2.center).toPolar().theta+Number(facingin.value)}function reference_center(){if(standard_point.value==part1.name){return part1.center}else{return part2.center}}function reallength(){return Number(distancein.value)/part1.center.sub(part2.center).toPolar().r}function reference_pos(){return new Pos(Number(standard_x.value),Number(standard_y.value))}function checknumber(e,t){e.oldvalue=e.value;e.numberchecker=function(){if(isNaN(Number(e.value))){e.value=e.oldvalue}if(t){e.value=""+Math.abs(Number(e.value))}e.oldvalue=e.value};e.addEventListener("input",e.numberchecker)}checknumber(facingin1,false);checknumber(facingin2,false);checknumber(facingin3,false);checknumber(facingin,false);checknumber(distancein,true);checknumber(standard_x,false);checknumber(standard_y,false);checknumber(attribute_x,false);checknumber(attribute_y,false);facingin.addEventListener("input",parts.updatepos);distancein.addEventListener("input",refresh_attributes);standard_x.addEventListener("input",refresh_attributes);standard_y.addEventListener("input",refresh_attributes);standard_point.addEventListener("change",refresh_attributes);first_standard_point.addEventListener("change",updatename);second_standard_point.addEventListener("change",updatename);triple_standard_point.addEventListener("change",function(){if(!third_standard_point.lastElementChild){triple_standard_point.checked=false}third_standard_point_div.hidden=!triple_standard_point.checked;standard_point_color_div.hidden=triple_standard_point.checked});window.setTimeout(init,1);btn_findgood.addEventListener("click",function(){if(window.confirm("注意!此功能會刪除部分的點且不可復原\n並且結果不一定適當\n建議備份後執行\n確定要執行嗎?")){var v={};var h=1;parts.forEach(function(e){if(e.parttype=="ThePoint"){var t=e.name;var r=e.center;var n=e.part1.center;var a=e.part2.center;var i=r.sub(posfinder(n,a,e.angle1+h,e.angle2+h)).length;var o=r.sub(posfinder(n,a,e.angle1-h,e.angle2+h)).length;var s=r.sub(posfinder(n,a,e.angle1+h,e.angle2-h)).length;var l=r.sub(posfinder(n,a,e.angle1-h,e.angle2-h)).length;var c=r.sub(posfinder(n,a,e.angle1+h,e.angle2)).length;var u=r.sub(posfinder(n,a,e.angle1,e.angle2+h)).length;var d=r.sub(posfinder(n,a,e.angle1,e.angle2-h)).length;var p=r.sub(posfinder(n,a,e.angle1-h,e.angle2)).length;var f=i+o+s+l+c+u+d+p;if(v[t]==undefined)v[t]=new Array;v[t].push({uuid:e.uuid,score:f})}});for(var e in v){var t=v[e];if(t.length>1){var r=1e7;var n=true;var a=false;var i=undefined;try{for(var o=t[Symbol.iterator](),s;!(n=(s=o.next()).done);n=true){var l=s.value;r=Math.min(r,l.score)}}catch(e){a=true;i=e}finally{try{if(!n&&o.return){o.return()}}finally{if(a){throw i}}}var c=true;var u=false;var d=undefined;try{for(var p=t[Symbol.iterator](),f;!(c=(f=p.next()).done);c=true){var _=f.value;if(_.score>r){parts.get(_.uuid).destroy()}}}catch(e){u=true;d=e}finally{try{if(!c&&p.return){p.return()}}finally{if(u){throw d}}}}}}});